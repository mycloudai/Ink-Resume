<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="pageTitle">简历模板编辑器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        :root {
            /* CSS变量，用于实时预览 */
            --live-title-font-size: 22px;
            --live-content-font-size: 14px;
            --live-line-height: 0.9;
            --live-page-padding: 15mm;
            --preview-scale: 0.8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f1f3f4;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 550px 1fr; 
            gap: 30px;
            min-height: calc(100vh - 40px);
            /* 移除固定高度，改为最小高度 */
        }

        .editor-panel {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 25px;
            overflow-y: auto;
            border: 1px solid #e8eaed;
            /* 固定高度，保持编辑面板滚动 */
            height: calc(100vh - 40px);
            position: sticky;
            top: 0;
        }

        .preview-panel {
            background: #f1f3f4;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            /* 移除高度和overflow限制，让内容自然展开 */
            position: relative;
            border: 1px solid #e8eaed;
            display: flex;
            justify-content: center;
            padding: 20px;
            /* 自适应内容高度 */
            min-height: calc(100vh - 40px);
        }

        .resume-preview {
            /* A4比例宽度，自适应容器 */
            width: 100%;
            max-width: calc(100vw - 650px); /* 减去编辑面板和间距 */
            min-height: auto;
            padding: var(--live-page-padding, 15mm);
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            position: relative;
            margin-bottom: 20px;
            /* 移除固定比例，让内容自然撑开高度 */
        }

        /* 完全移除分页指示器 */
        .resume-preview::after {
            display: none;
        }

        .page-indicator {
            display: none;
        }

        .section {
            margin-bottom: 20px;
            position: relative;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e8eaed;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section h3 {
            color: #3c4043;
            font-weight: 600;
            margin: 0;
        }

        .delete-section-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-section-btn:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #5f6368;
            font-size: 14px;
        }

        input[type="text"], input[type="email"], textarea, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            background-color: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus, input[type="email"]:focus, textarea:focus, input[type="number"]:focus {
            outline: none;
            border-color: #b8860b;
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .photo-upload {
            margin-bottom: 15px;
        }

        .photo-preview {
            width: 120px;
            height: 160px;
            border: 2px dashed #bdc1c6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            overflow: hidden;
            background-color: #f8f9fa;
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .photo-preview:hover {
            border-color: #b8860b;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            color: #80868b;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
        }

        .export-btn {
            background: linear-gradient(135deg, #5f6368 0%, #b8860b 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 25px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(184, 134, 11, 0.2);
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #4a4d52 0%, #9a7209 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(184, 134, 11, 0.3);
        }

        .add-section-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .add-section-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .resume-header {
            display: flex;
            gap: 12mm;
            align-items: flex-start;
            margin-bottom: 8mm;
        }

        .resume-photo {
            flex-shrink: 0;
            width: 120px;
            height: 160px;
        }

        .resume-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .resume-basic-info {
            flex: 1;
            height: 160px;
        }
        
        #basicInfoPreview {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        #basicInfoPreview > * {
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            line-height: var(--live-line-height) !important;
        }
        
        #basicInfoPreview h3 {
             font-size: var(--live-title-font-size) !important;
        }

        #basicInfoPreview p {
             font-size: var(--live-content-font-size) !important;
        }

        .resume-section {
            margin-bottom: 6mm;
        }

        .resume-section h2 {
            color: #3c4043;
            padding-bottom: 2mm;
            margin-bottom: 4mm;
            font-weight: 700;
            position: relative;
            border-bottom: 1.5px solid #b8860b !important;
            font-size: var(--live-title-font-size) !important;
        }

        .resume-content {
            color: #5f6368;
            font-size: var(--live-content-font-size) !important;
            line-height: var(--live-line-height) !important;
        }

        .resume-content h1,
        .resume-content h2,
        .resume-content h3,
        .resume-content h4,
        .resume-content h5,
        .resume-content h6 {
            color: #3c4043;
            margin-top: 4mm;
            margin-bottom: 2mm;
            font-weight: 600;
            border-bottom: none !important;
        }

        .resume-content ul {
            padding-left: 20px;
        }

        .resume-content li {
            margin-bottom: 1mm;
        }

        .resume-content p {
            margin-bottom: 2mm;
        }

        #printSettings {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            background: #f8f9fa;
        }

        #printSettings h4 {
            margin-bottom: 15px;
            color: #3c4043;
        }

        #printSettings input[type="range"] {
            width: 60%;
            margin-right: 10px;
            vertical-align: middle;
        }

        #printSettings span {
            color: #5f6368;
            font-weight: 600;
            vertical-align: middle;
        }

        /* 页面统计信息 */
        .page-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        /* 语言切换按钮样式 */
        .lang-switcher {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .lang-switcher button {
            padding: 8px 16px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lang-switcher button.active {
            background: #b8860b;
            color: white;
            border-color: #b8860b;
        }
    </style>
    
    <!-- ======================= 新增：多语言数据和逻辑 ======================= -->
    <script>
        const i18nData = {
            translations: {
                'zh-CN': {
                    pageTitle: '简历模板编辑器',
                    printResume: '打印简历',
                    exportData: '导出数据',
                    importData: '导入数据',
                    printSettings: '打印设置',
                    pageMargin: '左右页边距 (mm)',
                    scaling: '缩放 (%)',
                    titleFontSize: '标题字体大小 (px)',
                    contentFontSize: '内容字体大小 (px)',
                    lineHeight: '行距',
                    confirmPrint: '确认打印',
                    cancel: '取消',
                    basicInfo: '基本信息',
                    personalPhoto: '个人照片',
                    photoPlaceholder: '点击上传照片',
                    basicInfoMarkdown: '基本信息 (支持Markdown)',
                    basicInfoPlaceholder: '### 张三...',
                    addSection: '+ 添加新部分',
                    pageInfo: '页数',
                    addSectionDialogTitle: '添加新部分',
                    newSectionTitlePlaceholder: '输入部分标题',
                    ok: '确定',
                    delete: '删除',
                    dragToSort: '拖动此处排序',
                    // 提示信息
                    switchLangConfirm: '切换语言将会使用新语言的默认模板覆盖当前内容，确定要切换吗？',
                    enterSectionTitlePrompt: '请输入部分标题',
                    confirmDeleteSection: '确定要删除这个部分吗？',
                    exportError: '导出失败: ',
                    exportSuccessFilename: '简历数据.yaml',
                    importSuccess: '导入成功',
                    importError: '导入失败，文件格式可能不正确。'
                },
                'en-US': {
                    pageTitle: 'Resume Template Editor',
                    printResume: 'Print Resume',
                    exportData: 'Export Data',
                    importData: 'Import Data',
                    printSettings: 'Print Settings',
                    pageMargin: 'Page Margin (mm)',
                    scaling: 'Scaling (%)',
                    titleFontSize: 'Title Font Size (px)',
                    contentFontSize: 'Content Font Size (px)',
                    lineHeight: 'Line Height',
                    confirmPrint: 'Confirm & Print',
                    cancel: 'Cancel',
                    basicInfo: 'Basic Information',
                    personalPhoto: 'Personal Photo',
                    photoPlaceholder: 'Click to upload photo',
                    basicInfoMarkdown: 'Basic Information (Markdown Supported)',
                    basicInfoPlaceholder: '### John Doe...',
                    addSection: '+ Add New Section',
                    pageInfo: 'Pages',
                    addSectionDialogTitle: 'Add New Section',
                    newSectionTitlePlaceholder: 'Enter section title',
                    ok: 'OK',
                    delete: 'Delete',
                    dragToSort: 'Drag to sort',
                    // Alerts and Prompts
                    switchLangConfirm: 'Switching languages will overwrite current content with the new language\'s default template. Are you sure?',
                    enterSectionTitlePrompt: 'Please enter a section title',
                    confirmDeleteSection: 'Are you sure you want to delete this section?',
                    exportError: 'Export failed: ',
                    exportSuccessFilename: 'Resume_Data.yaml',
                    importSuccess: 'Import successful',
                    importError: 'Import failed. The file format might be incorrect.'
                }
            },
            defaultContent: {
                'zh-CN': {
                    basic_info: `### 张三\n**电话：** 138-0000-0000  \n**邮箱：** zhangsan@email.com  \n**地址：** 北京市朝阳区  \n**GitHub：** https://github.com/zhangsan`,
                    sections: [
                        { id: 'self-evaluation', title: '自我评价', content: '- 具有5年DevOps经验，熟悉云原生技术栈\n- 精通Docker、Kubernetes等容器技术\n- 擅长CI/CD流程设计和优化\n- 具备良好的问题分析和解决能力' },
                        { id: 'education', title: '教育背景', content: '### 北京大学 | 计算机科学与技术 | 本科 | 2015-2019\n- 主修课程：数据结构、算法、操作系统、计算机网络\n- GPA: 3.8/4.0\n- 获得优秀毕业生称号' },
                        { id: 'work-experience', title: '工作经历', content: '### 阿里巴巴 | DevOps工程师 | 2019.07 - 至今\n- 负责公司CI/CD流程的设计和优化，提升发布效率50%\n- 维护Kubernetes集群，保障服务稳定运行，可用性达99.9%\n- 使用Terraform进行基础设施即代码管理\n- 搭建监控告警系统，及时发现和处理系统异常' },
                        { id: 'project-experience', title: '项目经历', content: '### 微服务容器化项目 | 技术负责人 | 2023.01 - 2023.08\n- 将传统单体应用拆分为微服务架构\n- 使用Docker容器化部署，提升资源利用率30%\n- 技术栈：Kubernetes, Docker, Jenkins, GitLab CI\n- 项目成果：缩短发布周期从2周到1天' },
                        { id: 'skills-certificates', title: '证书及技能', content: '### 技能\n- **容器技术：** Docker, Kubernetes, Helm\n- **CI/CD：** Jenkins, GitLab CI, GitHub Actions\n- **云平台：** AWS, Azure, 阿里云\n\n### 证书\n- AWS Certified DevOps Engineer – Professional\n- Certified Kubernetes Administrator (CKA)' }
                    ],
                },
                'en-US': {
                    basic_info: `### John Doe\n**Phone:** 138-0000-0000  \n**Email:** john.doe@email.com  \n**Location:** New York, NY  \n**GitHub:** https://github.com/johndoe`,
                    sections: [
                        { id: 'summary', title: 'Summary', content: '- 5 years of experience in DevOps, proficient in cloud-native technology stack\n- Expert in container technologies like Docker and Kubernetes\n- Skilled in CI/CD pipeline design and optimization\n- Strong problem analysis and solving abilities' },
                        { id: 'education', title: 'Education', content: '### Stanford University | Computer Science | B.S. | 2015-2019\n- Major Courses: Data Structures, Algorithms, Operating Systems, Computer Networks\n- GPA: 3.8/4.0\n- Awarded title of Outstanding Graduate' },
                        { id: 'work-experience', title: 'Work Experience', content: '### Google | DevOps Engineer | 2019.07 - Present\n- Designed and optimized CI/CD processes, improving release efficiency by 50%\n- Maintained Kubernetes clusters, ensuring service stability with 99.9% uptime\n- Managed infrastructure as code using Terraform\n- Built monitoring and alerting systems to promptly detect and handle system anomalies' },
                        { id: 'project-experience', title: 'Project Experience', content: '### Microservice Containerization Project | Tech Lead | 2023.01 - 2023.08\n- Refactored a monolithic application into a microservices architecture\n- Deployed using Docker containers, increasing resource utilization by 30%\n- Tech Stack: Kubernetes, Docker, Jenkins, GitLab CI\n- Achievement: Reduced release cycle from 2 weeks to 1 day' },
                        { id: 'skills-certificates', title: 'Skills & Certificates', content: '### Skills\n- **Container Tech:** Docker, Kubernetes, Helm\n- **CI/CD:** Jenkins, GitLab CI, GitHub Actions\n- **Cloud Platforms:** AWS, Azure, Google Cloud\n\n### Certificates\n- AWS Certified DevOps Engineer – Professional\n- Certified Kubernetes Administrator (CKA)' }
                    ],
                }
            },
            defaultSettings: {
                title_font_size: 20,
                content_font_size: 13,
                scaling: 110,
                page_margin: 6,
                line_height: 0.9
            }
        };

        let currentLang = 'zh-CN'; // 默认语言

        function setLanguage(lang, isInitialLoad = false) {
            if (!i18nData.translations[lang]) return;

            // 如果不是首次加载，且切换了语言，则提示用户
            if (!isInitialLoad && lang !== currentLang) {
                if (!confirm(i18nData.translations[lang].switchLangConfirm)) {
                    return; // 用户取消
                }
            }
            
            currentLang = lang;
            document.documentElement.lang = lang;

            // 更新所有静态UI文本
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                const translation = i18nData.translations[lang][key];
                if (translation) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translation;
                    } else {
                        el.textContent = translation;
                    }
                }
            });
            
            // 更新语言切换按钮的激活状态
            document.querySelectorAll('.lang-switcher button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
            });

            // 如果不是首次加载，或首次加载时，加载默认数据
            if (!isInitialLoad) {
                 loadDefaultData(lang);
            }
        }
    </script>
</head>
<body>
    <!-- 页面信息显示 -->
    <div class="page-info" id="pageInfo">页数: 1</div>

    <div class="container">
        <!-- 编辑面板 -->
        <div class="editor-panel">
            <!-- 新增：语言切换器 -->
            <div class="lang-switcher">
                <button data-lang="zh-CN" onclick="setLanguage('zh-CN')">中文</button>
                <button data-lang="en-US" onclick="setLanguage('en-US')">English</button>
            </div>
            
            <button class="export-btn" onclick="showPrintSettings()" data-i18n-key="printResume">打印简历</button>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="exportData()" style="flex: 1; padding: 10px; background: #b8860b; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n-key="exportData">导出数据</button>
                <input type="file" id="importFile" accept=".yaml,.yml" style="display: none;" onchange="importData(event)">
                <button onclick="document.getElementById('importFile').click()" style="flex: 1; padding: 10px; background: #5f6368; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n-key="importData">导入数据</button>
            </div>
            
            <div id="printSettings" style="display: none;">
                <h4 data-i18n-key="printSettings">打印设置</h4>

                <div class="form-group">
                    <label data-i18n-key="pageMargin">左右页边距 (mm)</label>
                    <input type="range" id="pageMargin" min="1" max="25" value="6" oninput="updatePrintStyle()">
                    <span id="pageMarginValue">6mm</span>
                </div>

                <div class="form-group">
                    <label data-i18n-key="scaling">缩放 (%)</label>
                    <input type="range" id="scaling" min="50" max="150" value="120" oninput="updatePrintStyle()">
                    <span id="scalingValue">120%</span>
                </div>

                <div class="form-group">
                    <label data-i18n-key="titleFontSize">标题字体大小 (px)</label>
                    <input type="range" id="titleFontSize" min="12" max="28" value="22" oninput="updatePrintStyle()">
                    <span id="titleFontValue">22px</span>
                </div>
                
                <div class="form-group">
                    <label data-i18n-key="contentFontSize">内容字体大小 (px)</label>
                    <input type="range" id="contentFontSize" min="8" max="20" value="14" oninput="updatePrintStyle()">
                    <span id="contentFontValue">14px</span>
                </div>

                <div class="form-group">
                    <label data-i18n-key="lineHeight">行距</label>
                    <input type="range" id="lineHeight" min="0.2" max="1.5" step="0.1" value="0.9" oninput="updatePrintStyle()">
                    <span id="lineHeightValue">0.9</span>
                </div>
                
                <button class="export-btn" onclick="doPrint()" style="margin-top: 15px;" data-i18n-key="confirmPrint">确认打印</button>
                <button onclick="hidePrintSettings()" style="margin-top: 15px; margin-left: 10px; padding: 12px 20px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;" data-i18n-key="cancel">取消</button>
            </div>
            
            <div class="section" data-section-id="basic-info">
                <div class="section-header">
                    <h3 data-i18n-key="basicInfo">基本信息</h3>
                </div>
                <div class="form-group">
                    <label data-i18n-key="personalPhoto">个人照片</label>
                    <div class="photo-upload">
                        <div class="photo-preview" id="photoPreview">
                            <div class="photo-placeholder" data-i18n-key="photoPlaceholder">点击上传照片</div>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label data-i18n-key="basicInfoMarkdown">基本信息 (支持Markdown)</label>
                    <textarea id="basicInfo" data-i18n-key="basicInfoPlaceholder" placeholder="### 张三..."></textarea>
                </div>
            </div>
            
            <div id="dynamicSections"></div>
            
            <button class="add-section-btn" onclick="showAddSectionDialog()" data-i18n-key="addSection">+ 添加新部分</button>
        </div>

        <!-- 预览面板 -->
        <div class="preview-panel">
            <div class="resume-preview" id="resumePreview">
                <div class="resume-header">
                    <div class="resume-photo" id="resumePhoto" style="display: none;"></div>
                    <div class="resume-basic-info">
                         <div id="basicInfoPreview"></div>
                    </div>
                </div>
                <div id="dynamicSectionsPreview"></div>
            </div>
        </div>
    </div>

    <!-- 对话框等 -->
    <div id="addSectionDialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;">
        <h3 style="margin-bottom: 20px;" data-i18n-key="addSectionDialogTitle">添加新部分</h3>
        <input type="text" id="newSectionTitle" data-i18n-key="newSectionTitlePlaceholder" placeholder="输入部分标题" style="width: 300px; margin-bottom: 20px;">
        <div style="text-align: right;">
            <button onclick="addNewSection()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;" data-i18n-key="ok">确定</button>
            <button onclick="hideAddSectionDialog()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n-key="cancel">取消</button>
        </div>
    </div>
    <div id="dialogOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <script>
        // 全局配置 marked.js 解析器
        marked.setOptions({
            gfm: true,       // 保留：启用GitHub风格的Markdown，能更好地处理子列表。
            breaks: false,   // 关键修改：关闭自动<br>转换，让我们能手动控制段落。
            mangle: false,
            headerIds: false
        });
        
        let sections = [];
        let pageIndicators = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            setLanguage('zh-CN', true); // 首次加载，不弹窗
            loadDefaultData('zh-CN'); // 加载默认中文数据
            
            initializeBasicInfo();
            renderSections();
            updatePreview();
            updatePrintStyle();
            
            window.addEventListener('resize', updatePageIndicators);

            // --- 新增代码：开始 ---
            // 使用事件委托来处理所有 textarea 的 Tab 键输入
            const editorPanel = document.querySelector('.editor-panel');
            editorPanel.addEventListener('keydown', function(e) {
                // 检查事件是否发生在 textarea 元素上，并且按下的是 Tab 键
                if (e.target.tagName.toLowerCase() === 'textarea' && e.key === 'Tab') {
                    // 1. 阻止默认的焦点切换行为
                    e.preventDefault();

                    const textarea = e.target;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const value = textarea.value;
                    const tabReplacement = '    '; // 使用4个空格代替tab，兼容性更好

                    // 2. 在光标位置插入4个空格
                    textarea.value = value.substring(0, start) + tabReplacement + value.substring(end);

                    // 3. 将光标移动到插入的空格之后
                    textarea.selectionStart = textarea.selectionEnd = start + tabReplacement.length;
                    
                    // 4. 手动触发 input 事件，以便实时预览能够更新
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            // --- 新增代码：结束 ---
        }); 
        function updatePageIndicators() {
            // 移除所有分页指示器功能
            pageIndicators.forEach(indicator => indicator.remove());
            pageIndicators = [];
            
            const resumePreview = document.getElementById('resumePreview');
            const height = resumePreview.scrollHeight;
            
            // 简化页数计算，仅用于信息显示
            const pageHeight = 297 * 3.78; // A4高度转px
            const pageCount = Math.ceil(height / pageHeight);
            
            // 仅更新页数显示，不显示分页线
            const pageInfoText = i18nData.translations[currentLang].pageInfo || 'Pages';
            document.getElementById('pageInfo').textContent = `${pageInfoText}: ${pageCount}`;
        }
        
        function initializeBasicInfo() {
            const photoPreview = document.getElementById('photoPreview');
            const photoInput = document.getElementById('photoInput');
            photoPreview.addEventListener('click', () => photoInput.click());
            photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const photoPlaceholder = document.querySelector('.photo-placeholder');
                        if(photoPlaceholder) photoPlaceholder.style.display = 'none';
                        photoPreview.innerHTML = `<img src="${e.target.result}" alt="个人照片">`;
                        updateResumePhoto(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
            document.getElementById('basicInfo').addEventListener('input', () => {
                updatePreview();
            });
        }
        
        function renderSections() {
            const container = document.getElementById('dynamicSections');
            container.innerHTML = '';
            sections.forEach((section, index) => {
                const div = document.createElement('div');
                div.className = 'section';
                div.setAttribute('data-section-id', section.id);
                div.setAttribute('draggable', 'true');
                div.ondragstart = (e) => e.dataTransfer.setData('text/plain', index);
                div.ondragover = (e) => e.preventDefault();
                div.ondrop = (e) => {
                    e.preventDefault();
                    const draggedIndex = +e.dataTransfer.getData('text/plain');
                    if (draggedIndex !== index) {
                        const [moved] = sections.splice(draggedIndex, 1);
                        sections.splice(index, 0, moved);
                        renderSections();
                        updatePreview();
                    }
                };
                
                const deleteText = i18nData.translations[currentLang].delete;
                const dragText = i18nData.translations[currentLang].dragToSort;

                div.innerHTML = `
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button title="${dragText}" style="cursor: move; padding: 4px 8px; border: none; background: #dee2e6; border-radius: 4px; font-size: 12px;">↕</button>
                            <h3 style="margin: 0;">${section.title}</h3>
                        </div>
                        <button class="delete-section-btn" onclick="deleteSection('${section.id}')">${deleteText}</button>
                    </div>
                    <div class="form-group">
                        <textarea id="${section.id}">${section.content || ''}</textarea>
                    </div>`;
                div.querySelector('textarea').addEventListener('input', function () {
                    const s = sections.find(s => s.id === section.id);
                    if (s) s.content = this.value;
                    updatePreview();
                });
                container.appendChild(div);
            });
        }
        
        function showAddSectionDialog() {
            document.getElementById('dialogOverlay').style.display = 'block';
            document.getElementById('addSectionDialog').style.display = 'block';
            document.getElementById('newSectionTitle').value = '';
            document.getElementById('newSectionTitle').focus();
        }
        
        function hideAddSectionDialog() {
            document.getElementById('dialogOverlay').style.display = 'none';
            document.getElementById('addSectionDialog').style.display = 'none';
        }
        
        function addNewSection() {
            const title = document.getElementById('newSectionTitle').value.trim();
            if (!title) {
                alert(i18nData.translations[currentLang].enterSectionTitlePrompt);
                return;
            }
            sections.push({ id: 'section-' + Date.now(), title: title, content: '' });
            renderSections();
            updatePreview();
            hideAddSectionDialog();
        }
        
        function deleteSection(id) {
            if (confirm(i18nData.translations[currentLang].confirmDeleteSection)) {
                sections = sections.filter(s => s.id !== id);
                renderSections();
                updatePreview();
            }
        }

        function updatePreview() {
            // --- 第1部分：恢复“基本信息”的优雅布局 ---
            const basicInfoPreview = document.getElementById('basicInfoPreview');
            basicInfoPreview.innerHTML = '';
            const basicInfoText = document.getElementById('basicInfo').value;
            const lines = basicInfoText.split('\n');

            let firstHeadingFound = false;
            lines.forEach(line => {
                // 如果是H标签开头的行，作为大标题处理
                if (!firstHeadingFound && line.trim().startsWith('#')) {
                    basicInfoPreview.innerHTML += marked.parse(line);
                    firstHeadingFound = true;
                } 
                // 对于非空行，作为单独的<p>段落，并保留行内多空格
                else if (line.trim() !== '') {
                    const p = document.createElement('p');
                    // 使用parseInline来处理粗体、链接等，同时手动替换多空格
                    p.innerHTML = marked.parseInline(line.replace(/ {2,}/g, m => ' '.repeat(m.length)));
                    basicInfoPreview.appendChild(p);
                }
                // 空行会被自然忽略，从而在视觉上分隔了内容
            });

            // --- 第2部分：精确处理动态部分，支持子列表、空行和多空格 ---
            const dynamicSectionsPreview = document.getElementById('dynamicSectionsPreview');
            dynamicSectionsPreview.innerHTML = '';
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'resume-section';
                
                let processedContent = section.content || '';
                
                // 智能地保留行内多空格，同时不破坏行首的列表缩进
                const contentWithPreservedSpaces = processedContent.split('\n').map(line => {
                    const match = line.match(/^(\s*)(.*)$/); // 分离行首缩进和行内容
                    if (match) {
                        const indentation = match[1]; // 这是Markdown的缩进，必须保留
                        let content = match[2];     // 这是行的实际内容
                        // 只在实际内容里替换多空格为 
                        content = content.replace(/ {2,}/g, m => ' '.repeat(m.length));
                        return indentation + content;
                    }
                    return line;
                }).join('\n');
                
                // 将处理好的内容交给marked解析。
                // 因为 breaks:false，它会正确地将空行识别为段落分隔，并正确处理列表。
                const htmlContent = marked.parse(contentWithPreservedSpaces);
                
                sectionDiv.innerHTML = `
                    <h2>${section.title}</h2>
                    <div class="resume-content">${htmlContent}</div>`;
                dynamicSectionsPreview.appendChild(sectionDiv);
            });
            
            setTimeout(updatePageIndicators, 100);
        }

        function updateResumePhoto(src) {
            const resumePhoto = document.getElementById('resumePhoto');
            if (src) {
                resumePhoto.style.display = 'block';
                resumePhoto.innerHTML = `<img src="${src}" alt="个人照片">`;
            } else {
                resumePhoto.style.display = 'none';
                resumePhoto.innerHTML = '';
            }
        }
        
        function getPhotoData() {
            const img = document.querySelector('#photoPreview img');
            return img ? img.src : null;
        }
        
        function getCurrentSettings() {
            return {
                basic_info: document.getElementById('basicInfo').value,
                photo: getPhotoData(),
                sections: sections,
                print_settings: {
                    title_font_size: document.getElementById('titleFontSize').value,
                    content_font_size: document.getElementById('contentFontSize').value,
                    scaling: document.getElementById('scaling').value,
                    page_margin: document.getElementById('pageMargin').value,
                    line_height: document.getElementById('lineHeight').value
                }
            };
        }

        function exportData() {
            try {
                const data = getCurrentSettings();
                const yamlString = jsyaml.dump(data, { indent: 2, lineWidth: -1, noRefs: true });
                const blob = new Blob([yamlString], { type: 'text/yaml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = i18nData.translations[currentLang].exportSuccessFilename;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(i18nData.translations[currentLang].exportError + error.message);
            }
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = jsyaml.load(e.target.result);
                    applyData(data);
                    alert(i18nData.translations[currentLang].importSuccess);
                } catch (err) {
                    alert(i18nData.translations[currentLang].importError);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function applyData(data, lang = 'zh-CN') {
            const defaultContent = i18nData.defaultContent[lang] || i18nData.defaultContent['zh-CN'];

            document.getElementById('basicInfo').value = data.basic_info || defaultContent.basic_info;
            const photoSrc = data.photo || null;
            updateResumePhoto(photoSrc);
            const photoPreview = document.getElementById('photoPreview');
            const photoPlaceholderText = i18nData.translations[currentLang].photoPlaceholder;
            photoPreview.innerHTML = photoSrc ? `<img src="${photoSrc}" alt="photo">` : `<div class="photo-placeholder">${photoPlaceholderText}</div>`;
            
            sections = Array.isArray(data.sections) ? data.sections : defaultContent.sections;
            
            const ps = data.print_settings || i18nData.defaultSettings;
            document.getElementById('titleFontSize').value = ps.title_font_size;
            document.getElementById('contentFontSize').value = ps.content_font_size;
            document.getElementById('scaling').value = ps.scaling;
            document.getElementById('pageMargin').value = ps.page_margin;
            document.getElementById('lineHeight').value = ps.line_height;

            renderSections();
            updatePreview();
            updatePrintStyle();
        }

        function loadDefaultData(lang) {
            const dataToLoad = {
                basic_info: i18nData.defaultContent[lang].basic_info,
                photo: null,
                sections: i18nData.defaultContent[lang].sections,
                print_settings: i18nData.defaultSettings
            };
            applyData(dataToLoad, lang);
        }
        
        function showPrintSettings() { 
            document.getElementById('printSettings').style.display = 'block'; 
        }
        
        function hidePrintSettings() { 
            document.getElementById('printSettings').style.display = 'none'; 
        }
        
        function updatePrintStyle() {
            const titleFontSize = document.getElementById('titleFontSize').value;
            const contentFontSize = document.getElementById('contentFontSize').value;
            const scaling = document.getElementById('scaling').value;
            const pageMargin = document.getElementById('pageMargin').value;
            const lineHeight = document.getElementById('lineHeight').value;
            
            document.getElementById('titleFontValue').textContent = titleFontSize + 'px';
            document.getElementById('contentFontValue').textContent = contentFontSize + 'px';
            document.getElementById('scalingValue').textContent = scaling + '%';
            document.getElementById('pageMarginValue').textContent = pageMargin + 'mm';
            document.getElementById('lineHeightValue').textContent = lineHeight;

            // 仅更新预览样式的CSS变量
            document.documentElement.style.setProperty('--live-title-font-size', titleFontSize + 'px');
            document.documentElement.style.setProperty('--live-content-font-size', contentFontSize + 'px');
            document.documentElement.style.setProperty('--live-line-height', lineHeight);
            document.documentElement.style.setProperty('--live-page-padding', pageMargin + 'mm');

            // 使用原始简历代码的打印样式 - 完全独立
            let printStyleTag = document.getElementById('original-print-styles');
            if (!printStyleTag) {
                printStyleTag = document.createElement('style');
                printStyleTag.id = 'original-print-styles';
                document.head.appendChild(printStyleTag);
            }

            // 原始代码的打印样式 - 修复zoom问题
            printStyleTag.innerHTML = `
                @media print {
                    @page {
                        size: A4;
                        margin: 15mm ${pageMargin}mm;
                    }
                    body {
                        background: white !important;
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                        font-size: ${Math.round(contentFontSize * scaling / 100)}px !important;
                    }
                    .container {
                        display: block !important;
                    }
                    .editor-panel {
                        display: none !important;
                    }
                    .preview-panel {
                        display: block !important;
                        padding: 0 !important;
                        border: none !important;
                        box-shadow: none !important;
                        background: white !important;
                        overflow: visible !important;
                    }
                    .resume-preview {
                        padding: 0 !important;
                        box-shadow: none !important;
                        page-break-inside: auto;
                        min-height: auto !important;
                        height: auto !important;
                        width: 100% !important;
                        max-width: none !important;
                        /* 移除zoom，使用字体缩放代替 */
                    }
                    .page-info {
                        display: none !important;
                    }
                    .resume-header {
                        margin-bottom: 8mm !important;
                        page-break-after: avoid;
                        page-break-inside: avoid;
                        display: flex !important;
                        gap: 12mm !important;
                        align-items: flex-start !important;
                    }
                    .resume-photo {
                        flex-shrink: 0 !important;
                        width: ${Math.round(120 * scaling / 100)}px !important;
                        height: ${Math.round(160 * scaling / 100)}px !important;
                    }
                    .resume-photo img {
                        width: 100% !important;
                        height: 100% !important;
                        object-fit: cover !important;
                        border-radius: 8px !important;
                    }
                    .resume-basic-info {
                        flex: 1 !important;
                        height: ${Math.round(160 * scaling / 100)}px !important;
                    }
                    #basicInfoPreview {
                        height: 100% !important;
                        display: flex !important;
                        flex-direction: column !important;
                        justify-content: space-between !important;
                    }
                    #basicInfoPreview > * {
                        margin: 0 !important;
                        padding: 0 !important;
                        border: none !important;
                        line-height: ${lineHeight} !important;
                    }
                    .resume-section {
                        margin-bottom: 6mm !important;
                        page-break-inside: auto;
                    }
                    .resume-section h2 {
                        font-size: ${Math.round(titleFontSize * scaling / 100)}px !important;
                        padding-bottom: 2mm !important;
                        margin-bottom: 4mm !important;
                        page-break-after: avoid;
                        page-break-inside: avoid;
                        color: #3c4043 !important;
                        font-weight: 700 !important;
                        border-bottom: 1.5px solid #b8860b !important;
                    }
                    #basicInfoPreview h3 {
                        font-size: ${Math.round(titleFontSize * scaling / 100)}px !important;
                        color: #3c4043 !important;
                        font-weight: 600 !important;
                    }
                    #basicInfoPreview p, .resume-content {
                        font-size: ${Math.round(contentFontSize * scaling / 100)}px !important;
                        line-height: ${lineHeight} !important;
                        color: #5f6368 !important;
                    }
                    .resume-content h1,
                    .resume-content h2,
                    .resume-content h3,
                    .resume-content h4,
                    .resume-content h5,
                    .resume-content h6 {
                        color: #3c4043 !important;
                        margin-top: 4mm !important;
                        margin-bottom: 2mm !important;
                        font-weight: 600 !important;
                        border-bottom: none !important;
                    }
                    .resume-content p {
                        orphans: 3;
                        widows: 3;
                        margin-bottom: 2mm !important;
                    }
                    .resume-content li {
                        page-break-inside: avoid;
                        margin-bottom: 1mm !important;
                    }
                    .resume-content ul {
                        padding-left: 20px !important;
                    }
                }
            `;
            
            // 更新页面指示器
            setTimeout(updatePageIndicators, 100);
        }
        
        function stripLinks(containerElement) {
            const links = containerElement.querySelectorAll('a');
            links.forEach(link => {
                const span = document.createElement('span');
                span.textContent = link.textContent;
                link.parentNode.replaceChild(span, link);
            });
        }

        function doPrint() {
            hidePrintSettings();
            
            // 隐藏页面信息
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.style.display = 'none';
            
            stripLinks(document.getElementById('resumePreview'));
            
            setTimeout(() => {
                window.print();
                
                // 恢复显示
                pageInfo.style.display = 'block';
                updatePreview();
            }, 100);
        }
    </script>
</body>
</html>
